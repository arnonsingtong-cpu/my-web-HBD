<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday My Love</title>
    
    <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏£‡∏á‡πÅ‡∏ó‡πá‡∏ö Browser (Favicon) - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô href ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ -->
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2913/2913564.png" type="image/x-icon">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;600;700&family=Prompt:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Mali', cursive;
            background-color: #ffe4e6;
            background-image: radial-gradient(#fbcfe8 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            user-select: none;
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Envelope Styles --- */
        .envelope-wrapper {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
            padding: 20px;
            z-index: 50;
        }
        .envelope-wrapper:hover { transform: scale(1.02); }

        .envelope {
            position: relative;
            width: 320px;
            height: 220px;
            background-color: #f43f5e;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            box-shadow: 0 15px 35px rgba(244, 63, 94, 0.3);
            z-index: 10;
        }

        .lid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 110px;
            background-color: #f43f5e;
            clip-path: polygon(0 0, 50% 100%, 100% 0);
            transform-origin: top;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), z-index 0.2s;
            z-index: 40;
            border-top: 2px solid #e11d48;
        }

        .lid.open { transform: rotateX(180deg); z-index: 1; }

        .pocket {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 110px;
            background-color: #e11d48; clip-path: polygon(0 100%, 50% 0, 100% 100%); z-index: 30;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
        }
        
        .pocket-sides {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            background-color: #fda4af; clip-path: polygon(0 0, 0 100%, 100% 100%, 100% 0, 50% 50%); z-index: 20;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
        }

        /* --- Letter Styles --- */
        .letter {
            position: absolute; top: 10px; left: 10px; width: 300px; height: 420px;
            background: linear-gradient(to bottom, #ffffff, #fff1f2);
            border-radius: 12px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 5;
            transition: all 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex; flex-direction: column; align-items: center; padding: 15px;
            text-align: center; opacity: 0; pointer-events: auto;
        }

        .letter.pulled {
            top: -300px; transform: translateY(20px) scale(1.1); z-index: 50; opacity: 1;
            height: auto; min-height: 580px; max-height: 95vh; overflow: hidden; 
        }

        h1#mainTitle { flex-shrink: 0; }

        /* --- Card Stack Styles --- */
        .card-stack-container {
            position: relative; width: 240px; height: 270px; margin: 5px auto;
            perspective: 1000px; transition: opacity 0.5s ease, height 0.5s ease; flex-shrink: 0;
        }

        .polaroid-card {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; padding: 8px 8px 40px 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 4px;
            transform-origin: 50% 100%; transition: transform 0.1s linear; 
            cursor: grab; display: flex; flex-direction: column;
            border: 1px solid #eee; -webkit-user-drag: none; 
        }
        .polaroid-card:active { cursor: grabbing; }

        .polaroid-card img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 2px;
            pointer-events: none; background-color: #f0f0f0;
        }

        .polaroid-caption {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; 
            display: flex; align-items: center; justify-content: center;
            font-family: 'Mali', cursive; color: #555; font-size: 13px; font-weight: bold; pointer-events: none;
        }

        /* --- Content & Sections --- */
        .content-wrapper {
            width: 100%; flex-grow: 1; position: relative;
            display: flex; flex-direction: column; align-items: center;
            margin-top: 2px; min-height: 100px; 
        }

        .section {
            width: 100%; transition: opacity 0.8s ease; position: absolute; top: 0; left: 0;
        }
        .active-section { opacity: 1; z-index: 10; pointer-events: auto; position: relative; }
        .hidden-section { opacity: 0; z-index: 0; pointer-events: none; position: absolute; }

        /* Lyrics Box */
        .lyrics-container {
            width: 100%; height: 100px; overflow-y: hidden;
            background: rgba(255, 255, 255, 0.5); border-radius: 8px; padding: 2px 5px;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
        }
        .lyric-line {
            font-family: 'Prompt', sans-serif; font-size: 13px; color: #9ca3af;
            margin: 6px 0; transition: all 0.3s ease; text-align: center;
        }
        .lyric-line.active { color: #f43f5e; font-size: 16px; font-weight: 700; transform: scale(1.05); }

        /* Wishes Box */
        .wishes-container {
            text-align: center; padding: 25px 20px 10px 20px; background: #fff;
            border-radius: 12px; border: 2px dashed #f43f5e;
            box-shadow: 0 8px 20px rgba(244, 63, 94, 0.1); margin-top: 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 280px; 
        }

        /* Music Player */
        .music-player {
            width: 100%; margin-top: auto; background: #fff0f5; border-radius: 20px;
            padding: 8px 12px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0;
        }

        /* Heart Seal */
        .heart-seal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 45px; color: #be123c; z-index: 50;
            animation: beat 1.5s infinite; cursor: pointer;
            background: white; border-radius: 50%; width: 60px; height: 60px;
            display: flex; justify-content: center; align-items: center;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); pointer-events: auto; 
        }
        @keyframes beat { 0%, 100% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } }
        
        .click-hint {
            position: absolute; bottom: -50px; width: 100%; text-align: center;
            color: #be123c; font-weight: 700; font-size: 1.1rem;
            animation: fadeInOut 2s infinite; text-shadow: 0 1px 2px rgba(255,255,255,0.8); pointer-events: none;
        }
        @keyframes fadeInOut { 0%, 100% { opacity: 0.6; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-5px); } }

        .fly-out-left { transition: transform 0.5s ease-out !important; transform: translateX(-1000px) rotate(-30deg) !important; }
        .fly-out-right { transition: transform 0.5s ease-out !important; transform: translateX(1000px) rotate(30deg) !important; }

        /* Easter Egg */
        .gift-box {
            font-size: 36px; color: #f43f5e; cursor: pointer;
            animation: wiggle 2s linear infinite; transition: transform 0.3s;
            display: inline-block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .gift-box:hover { transform: scale(1.2); }
        @keyframes wiggle {
            0%, 7% { transform: rotateZ(0); } 15% { transform: rotateZ(-15deg); } 20% { transform: rotateZ(10deg); }
            25% { transform: rotateZ(-10deg); } 30% { transform: rotateZ(6deg); } 35% { transform: rotateZ(-4deg); } 40%, 100% { transform: rotateZ(0); }
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 15px; text-align: center;
            max-width: 80%; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; border: 4px solid #f43f5e; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="relative w-full h-full flex justify-center items-center px-4">
        
        <!-- ‡∏ã‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
        <div class="envelope-wrapper" id="envelopeWrapper">
            <div class="envelope">
                <div class="lid" id="lid"></div>
                <div class="pocket-sides"></div>
                <div class="pocket"></div>
                
                <div class="letter" id="letter">
                    <h1 class="text-xl font-bold text-rose-600 font-prompt mb-2 mt-2" id="mainTitle">Happy Birthday üéÇ</h1>
                    <div class="card-stack-container" id="cardStack"></div>
                    <div class="content-wrapper">
                        
                        <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á -->
                        <div id="section-lyrics" class="section active-section">
                            <div class="flex items-center justify-center gap-2 mb-1">
                                <span class="text-[10px] text-rose-400 font-bold tracking-widest uppercase">Now Playing</span>
                                <div class="flex items-end h-2 gap-0.5">
                                    <div class="w-0.5 bg-rose-400 animate-pulse h-1.5"></div>
                                    <div class="w-0.5 bg-rose-400 animate-pulse h-2"></div>
                                    <div class="w-0.5 bg-rose-400 animate-pulse h-1"></div>
                                </div>
                            </div>
                            <div class="lyrics-container" id="lyricsBox"></div>
                            <p class="text-xs text-gray-400 mt-2 animate-pulse" id="swipeHint">
                                <i class="fas fa-hand-pointer"></i> ‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏¥‡πâ‡∏á
                            </p>
                        </div>

                        <!-- ‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£ -->
                        <div id="section-wishes" class="section hidden-section w-full px-2">
                            <div class="wishes-container">
                                <i class="fas fa-quote-left text-rose-300 text-2xl mb-2 self-start"></i>
                                <h3 class="font-bold text-rose-600 mb-4 text-lg text-center font-prompt">To: My Love ‚ù§Ô∏è</h3>
                                <p class="text-sm text-gray-700 leading-relaxed font-mali text-center px-2">
                                    ‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å! üéâ<br><br>
                                    ‡∏î‡∏µ‡πÉ‡∏à‡∏°‡∏≤‡∏Å‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ò‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏î‡∏µ‡πÜ ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏ô‡∏∞ <br><br>
                                    ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠ ‡∏¢‡∏¥‡πâ‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏°‡∏≤‡∏Å‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏±‡∏Å‡∏ô‡∏∞! üíñ
                                </p>
                                <i class="fas fa-quote-right text-rose-300 text-2xl mt-2 self-end"></i>
                                
                                <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç -->
                                <div class="mt-4 flex flex-col items-center cursor-pointer" onclick="openSurprise(); event.stopPropagation();">
                                    <p class="text-[10px] text-gray-400 mb-1 animate-bounce">‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°...</p>
                                    <i class="fas fa-gift gift-box"></i>
                                </div>
                            </div>
                            
                            <button onclick="initCards(); event.stopPropagation();" class="mt-2 text-xs text-gray-400 underline flex items-center justify-center w-full gap-1 hover:text-rose-500 transition-colors">
                                <i class="fas fa-undo"></i> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                            </button>
                        </div>

                    </div>

                    <!-- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á -->
                    <div class="music-player" onclick="event.stopPropagation()">
                        <button onclick="toggleMusic(event)" class="w-8 h-8 rounded-full bg-rose-500 text-white flex items-center justify-center hover:bg-rose-600 transition shadow-md flex-shrink-0">
                            <i class="fas fa-play text-xs" id="playIcon"></i>
                        </button>
                        <div class="flex flex-col flex-grow ml-2 overflow-hidden">
                            <span class="text-xs font-bold text-gray-800 truncate">‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏´‡∏ß‡∏±‡∏á</span>
                            <div class="w-full bg-gray-200 rounded-full h-1 mt-1">
                                <div class="bg-rose-500 h-1 rounded-full transition-all duration-500" style="width: 0%" id="progressBar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="heart-seal" id="heartSeal">
                    <i class="fas fa-heart text-2xl text-rose-600"></i>
                </div>
            </div>
            
            <div class="click-hint" id="clickHint">Open Me! ‚ú®</div>
        </div>
    </div>

    <!-- Surprise Modal -->
    <div id="surpriseModal" class="modal-overlay" onclick="closeSurprise()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <!-- ‡∏£‡∏π‡∏õ‡∏ï‡∏•‡∏Å‡πÜ (‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô src ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå ‡πÄ‡∏ä‡πà‡∏ô 'funny.jpg') -->
            <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExajJ4aG1rcGh6Z2V6Zm56aG56aG56aG56aG56aG56aG56aG56/Lq0h93752f6J9tijzf/giphy.gif" class="w-40 h-40 object-cover rounded-lg mb-3 mx-auto border-2 border-pink-200 shadow-md">
            
            <p class="font-bold text-xl text-rose-600 font-mali mb-1">‡πÅ‡∏ö‡∏£‡πà! üòú</p>
            <p class="text-sm text-gray-600">‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏ô? ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏à‡πÑ‡∏á!</p>
            <p class="text-xs text-gray-400 mt-1">(‡∏£‡∏±‡∏Å‡∏ô‡∏∞ ‡∏à‡∏∏‡πä‡∏ö‡πÜ)</p>
            
            <button onclick="closeSurprise()" class="mt-4 bg-rose-500 text-white px-5 py-2 rounded-full text-sm hover:bg-rose-600 transition shadow-lg">
                ‡πÇ‡∏≠‡πÄ‡∏Ñ ‡∏¢‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß üòÇ
            </button>
        </div>
    </div>

    <audio id="bgMusic" loop></audio>

    <script>
        // ============================================
        // üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô GitHub Pages)
        // ============================================

        // 1. ‡πÄ‡∏û‡∏•‡∏á: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏•‡∏á (‡πÄ‡∏ä‡πà‡∏ô song.mp3) ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö index.html 
        // ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô: const SONG_URL = 'song.mp3';
        const SONG_URL = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'; 
        
        // 2. ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô src ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
        // ‡πÄ‡∏ä‡πà‡∏ô { src: "photo1.jpg", caption: "..." },
        const photos = [
            { src: "https://images.unsplash.com/photo-1513201099705-a9746e1e201f?q=80&w=1000", caption: "‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô ‚ù§Ô∏è" },
            { src: "https://images.unsplash.com/photo-1530103862676-de3c9a59af38?q=80&w=1000", caption: "‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏∞‡πÄ‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏±‡πâ‡∏ô üåä" },
            { src: "https://images.unsplash.com/photo-1606983340126-99ab4feaa64a?q=80&w=1000", caption: "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏±‡∏ô üêª" },
            { src: "https://images.unsplash.com/photo-1518895949257-7621c3c786d7?q=80&w=1000", caption: "‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á ‚ú®" }
        ];

        // 3. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á
        const lyricsData = [
            { time: 0, text: "(‡∏î‡∏ô‡∏ï‡∏£‡∏µ Intro...)" },
            { time: 8, text: "‡∏ü‡πâ‡∏≤..." },
            { time: 12, text: "‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ò‡∏≠‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤" },
            { time: 16, text: "‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤..." },
            { time: 20, text: "‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô" },
            { time: 25, text: "‡∏Å‡∏•‡∏±‡∏ß..." },
            { time: 28, text: "‡∏Å‡∏•‡∏±‡∏ß‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏ò‡∏≠‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ" },
            { time: 32, text: "‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏±‡∏Å‡∏â‡∏±‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡πÅ‡∏•‡πâ‡∏ß" },
            { time: 40, text: "‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏´‡∏ß‡∏±‡∏á" },
            { time: 45, text: "‡∏≠‡∏¢‡πà‡∏≤‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à" },
            { time: 50, text: "‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°" }
        ];

        // ============================================

        let isOpened = false;
        let isPlaying = false;
        
        const audio = document.getElementById("bgMusic");
        const playIcon = document.getElementById("playIcon");
        const lyricsBox = document.getElementById("lyricsBox");
        const progressBar = document.getElementById("progressBar");
        const cardStack = document.getElementById("cardStack");

        // Start Event Listener
        window.addEventListener('load', function() {
            const wrapper = document.getElementById("envelopeWrapper");
            if(wrapper) {
                wrapper.addEventListener("click", openLetter);
                wrapper.addEventListener("touchstart", function(e) {
                    if(!isOpened) openLetter();
                }, {passive: true});
            }
        });

        function initCards() {
            document.getElementById("section-wishes").classList.add("hidden-section");
            document.getElementById("section-wishes").classList.remove("active-section");
            document.getElementById("section-lyrics").classList.remove("hidden-section");
            document.getElementById("section-lyrics").classList.add("active-section");
            
            cardStack.style.display = 'block';
            cardStack.style.opacity = '1';
            cardStack.innerHTML = '';
            
            [...photos].reverse().forEach((photo, index) => {
                const card = document.createElement('div');
                card.className = 'polaroid-card';
                card.innerHTML = `
                    <img src="${photo.src}" draggable="false">
                    <div class="polaroid-caption">${photo.caption}</div>
                `;
                const randomRotate = (Math.random() * 6 - 3).toFixed(2);
                card.style.transform = `rotate(${randomRotate}deg)`;
                card.dataset.rotation = randomRotate;
                cardStack.appendChild(card);
            });

            setupSwipe();
        }

        function setupSwipe() {
            const cards = document.querySelectorAll('.polaroid-card');
            cards.forEach((card, index) => {
                if (index === cards.length - 1) {
                    addInteractions(card);
                } else {
                    card.style.cursor = 'default';
                }
            });

            if (cards.length === 0) {
                showWishes();
            }
        }

        function addInteractions(card) {
            let isDragging = false;
            let startX, currentX;
            const baseRotation = parseFloat(card.dataset.rotation || 0);

            card.addEventListener('mousedown', start);
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', end);

            card.addEventListener('touchstart', start, {passive: false});
            document.addEventListener('touchmove', move, {passive: false});
            document.addEventListener('touchend', end);

            function start(e) {
                isDragging = true;
                startX = getClientX(e);
                card.style.transition = 'none'; 
                card.style.cursor = 'grabbing';
            }

            function move(e) {
                if (!isDragging) return;
                currentX = getClientX(e);
                const diffX = currentX - startX;
                const rotation = baseRotation + (diffX * 0.1); 
                card.style.transform = `translateX(${diffX}px) rotate(${rotation}deg)`;
            }

            function end(e) {
                if (!isDragging) return;
                isDragging = false;
                card.style.cursor = 'grab';
                card.style.transition = 'transform 0.3s ease-out'; 

                const diffX = (currentX || startX) - startX;
                const threshold = 100; 

                if (diffX > threshold) {
                    card.classList.add('fly-out-right'); 
                    setTimeout(() => removeCard(card), 300);
                } else if (diffX < -threshold) {
                    card.classList.add('fly-out-left'); 
                    setTimeout(() => removeCard(card), 300);
                } else {
                    card.style.transform = `rotate(${baseRotation}deg)`; 
                }
            }
            
            function getClientX(e) {
                return e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            }
        }

        function removeCard(card) {
            card.remove();
            setupSwipe(); 
        }

        function showWishes() {
            const lyricsSec = document.getElementById("section-lyrics");
            const wishesSec = document.getElementById("section-wishes");
            
            lyricsSec.classList.remove("active-section");
            lyricsSec.classList.add("hidden-section");

            cardStack.style.transition = "opacity 0.3s ease";
            cardStack.style.opacity = "0";
            setTimeout(() => {
                cardStack.style.display = 'none';
                wishesSec.classList.remove("hidden-section");
                wishesSec.classList.add("active-section");
            }, 300);
        }

        function processAudioUrl(url) {
            // Logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive/Dropbox ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°
            if (url.includes('drive.google.com')) {
                let fileId = '';
                const parts = url.split('/');
                for (let i = 0; i < parts.length; i++) {
                    if (parts[i] === 'd') { fileId = parts[i + 1]; break; }
                }
                if (fileId) return `https://drive.google.com/uc?export=download&id=${fileId}`;
            }
            if (url.includes('dropbox.com')) return url.replace('dl=0', 'raw=1').replace('?dl=0', '?raw=1');
            return url; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (song.mp3) ‡∏Å‡πá‡∏à‡∏∞ return ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏ã‡∏∂‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
        }

        audio.src = processAudioUrl(SONG_URL);
        audio.volume = 0.5;

        function initLyrics() {
            lyricsBox.innerHTML = "";
            lyricsData.forEach((line, index) => {
                const div = document.createElement("div");
                div.classList.add("lyric-line");
                div.id = `line-${index}`;
                div.innerText = line.text;
                lyricsBox.appendChild(div);
            });
        }
        initLyrics();

        audio.ontimeupdate = () => {
            if (audio.duration) progressBar.style.width = (audio.currentTime / audio.duration) * 100 + "%";
            lyricsData.forEach((line, index) => {
                const div = document.getElementById(`line-${index}`);
                if (audio.currentTime >= line.time) {
                    document.querySelectorAll('.lyric-line').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    if (index > 0 && document.getElementById("section-lyrics").classList.contains("active-section")) {
                        const container = document.getElementById("lyricsBox");
                        const scrollPosition = div.offsetTop - (container.clientHeight / 2) + (div.clientHeight / 2);
                        container.scrollTo({
                            top: scrollPosition,
                            behavior: 'smooth'
                        });
                    }
                }
            });
        };

        function openLetter() {
            if (isOpened) return;
            isOpened = true;

            document.getElementById("lid").classList.add("open");
            document.getElementById("heartSeal").style.transform = "scale(0)";
            setTimeout(() => document.getElementById("heartSeal").style.display = 'none', 300);
            document.getElementById("clickHint").style.display = "none";

            setTimeout(() => {
                document.getElementById("envelopeWrapper").style.cursor = "default";
                const wrapper = document.getElementById("envelopeWrapper");
                wrapper.removeEventListener("click", openLetter);
                
                document.getElementById("letter").classList.add("pulled");
                initCards(); 
                playMusic();
            }, 600);
        }

        function playMusic() {
            audio.play().then(() => {
                isPlaying = true;
                playIcon.classList.remove("fa-play");
                playIcon.classList.add("fa-pause");
            }).catch(e => console.log("Interaction required"));
        }

        function toggleMusic(e) {
            e.stopPropagation();
            if (isPlaying) { audio.pause(); isPlaying = false; playIcon.classList.remove("fa-pause"); playIcon.classList.add("fa-play"); }
            else { audio.play(); isPlaying = true; playIcon.classList.remove("fa-play"); playIcon.classList.add("fa-pause"); }
        }

        function openSurprise() {
            document.getElementById('surpriseModal').style.display = 'flex';
        }
        function closeSurprise() {
            document.getElementById('surpriseModal').style.display = 'none';
        }

    </script>
</body>
</html>